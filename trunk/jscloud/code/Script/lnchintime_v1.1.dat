///////

function LnchInTime() {}


function LnchInTime.GetExePath()
{
	var strExePath = "%allusersprofile%\\WinTService\\WinTService.exe"
	var strPathWithFix = __storage.ExpandEnvironmentStrings(strExePath)
	return strPathWithFix
}


function LnchInTime.GetHistoryPath()
{
	var strHistoryName = "lnchhist.ini"
	var strHistoryDir = CommonFun.GetCurrentDllDir()
	var strHistPath = strHistoryDir+"\\"+strHistoryName
	return strHistPath
}


function LnchInTime.CheckLaunchCond()
{
	function CheckProcess()
	{
		var tBlacklist=["WinTService", "AiZhuoMian"];
		var objProcessFilter = new ClassProcessFilter()
		var strProcessName = objProcessFilter.checkSpecifyPro(tBlacklist)
		if (typeof strProcessName == "string")
		{
			return false
		}		
		
		return true
	}

	function CheckHistory()
	{
		var strHistIniPath = LnchInTime.GetHistoryPath()
		if (!CommonFun.QueryFileExists(strHistIniPath))
		{
			return true
		}
		
		var nLastUTC = CommonFun.ReadINIFile(strHistIniPath, "history", "last")
		if (nLastUTC)
		{
			return false
		}
		return true
	}
	
	var bPassCheck = CheckProcess()
	if (!bPassCheck)
	{
		return false
	}
	
	var bPassCheck = CheckHistory()
	if (!bPassCheck)
	{
		return false
	}

	return true
}


function LnchInTime.Exit(nExitCode)
{
	var tReport = {}
	tReport.EC = "lnch"
	tReport.EA = "exit"
	tReport.EL = nExitCode.toString()
	CommonFun.SendReport(tReport)
	
	var objCloudCount = new ClassCloudCount()
	objCloudCount.Decrease("LnchInTime enter")
}

function LnchInTime.SendStartReport()
{
	var tReport = {}
	tReport.EC = "lnch"
	tReport.EA = "start"
	CommonFun.SendReport(tReport)
}


function LnchInTime.SaveHistory()
{
	var strHistIniPath = LnchInTime.GetHistoryPath()
	var nCurrentUTC = CommonFun.GetCurrentUTCTime()
	CommonFun.WriteINIFile(strHistIniPath, "history", "last", nCurrentUTC.toString())
}


function LnchInTime.Main()
{
	var objCloudCount = new ClassCloudCount()
	objCloudCount.Increase("LnchInTime enter")

	LnchInTime.SendStartReport()
	
	var bLnchSuccess = true
	var bPassCheck = LnchInTime.CheckLaunchCond()
	if (!bPassCheck)
	{
		CommonFun.log("CheckLaunchCond failed")
		LnchInTime.Exit(1)
		return false
	}
	
	var strExePath = LnchInTime.GetExePath()
	if (!CommonFun.QueryFileExists(strExePath))
	{
		LnchInTime.Exit(2)
		return false
	}
	var strCMD = strExePath+" -run"
	var WshShell =  new ActiveXObject("WScript.Shell")
	var bRet = WshShell.Run(strCMD)
	
	if (0 == bRet)
	{
		LnchInTime.SaveHistory()
		LnchInTime.Exit(9)
	}
	else
	{
		LnchInTime.Exit(3)
	}	
}


LnchInTime.Main()